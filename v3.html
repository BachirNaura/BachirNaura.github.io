<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SahelStats Pro </title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4F46E5;       --primary-dark: #4338ca;  --primary-light: #e0e7ff;
            --secondary: #0f172a;     --surface: #ffffff;       --background: #f1f5f9;
            --text-main: #1e293b;     --text-muted: #64748b;
            --success: #10b981;       --warning: #f59e0b;       --danger: #ef4444;      --info: #0ea5e9;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --radius-md: 0.5rem;      --radius-xl: 1rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; }

        /* Navbar */
        .navbar { background: var(--surface); border-bottom: 1px solid var(--border); height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; position: sticky; top: 0; z-index: 50; }
        .brand { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        .brand span { color: var(--secondary); }
        .nav-profile { display: flex; align-items: center; gap: 1rem; font-size: 0.9rem; color: var(--text-muted); }
        .avatar { width: 38px; height: 38px; background: var(--primary-light); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }

        .main-container { flex: 1; padding: 2rem; max-width: 1400px; margin: 0 auto; width: 100%; }

        /* Components */
        .card { background: var(--surface); border-radius: var(--radius-xl); padding: 1rem; border: 1px solid var(--border); margin-bottom: 1.5rem; box-shadow: var(--shadow-sm); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: var(--radius-md); font-weight: 500; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-danger { background: #fee2e2; color: #991b1b; }
        .btn-info { background: var(--info); color: white; }
        .btn-ghost { background: transparent; color: var(--text-muted); padding: 0.5rem; }
        
        .form-control { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: var(--radius-md); background: #fcfcfc; }
        .input-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 500; margin-bottom: 0.5rem; }

        /* Utils */
        .flex-between { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .flex-end { display: flex; justify-content: flex-end; gap: 0.75rem; flex-wrap: wrap; }
        .hidden { display: none !important; }
        .text-sm { font-size: 0.85rem; color: var(--text-muted); }
        
        /* Badges & Tables */
        .badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .badge-draft { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .badge-published { background: #ecfdf5; color: #047857; border: 1px solid #d1fae5; }
        
        .table-wrapper { overflow-x: auto; border-radius: 0.75rem; border: 1px solid var(--border); background: white; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 1rem; border-bottom: 1px solid var(--border); text-align: left; }
        th { background: #f8fafc; font-weight: 600; color: var(--text-muted); white-space: nowrap; }
        td[contenteditable="true"]:focus { background: white; box-shadow: inset 0 0 0 2px var(--primary); padding: 0.9rem; outline: none; }

        /* Drag and Drop */
        .draggable-item { cursor: move; }
        .drag-handle { cursor: grab; padding: 0.5rem; color: var(--text-muted); font-size: 1.2rem; }
        .drag-over { border: 2px dashed var(--primary) !important; background: var(--primary-light) !important; }

        /* Toaster */
        #toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 100; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background: var(--secondary); color: white; padding: 1rem 1.5rem; border-radius: var(--radius-md); display: flex; align-items: center; gap: 0.75rem; min-width: 300px; animation: slideIn 0.3s; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.warning { border-left: 4px solid var(--warning); background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
        .toast.error { border-left: 4px solid var(--danger); }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 2rem; border-radius: var(--radius-xl); width: 90%; max-width: 450px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .file-drop-area { border: 2px dashed var(--border); padding: 2rem; text-align: center; margin: 1rem 0; cursor: pointer; border-radius: var(--radius-md); transition: background 0.2s; }
        .file-drop-area:hover { background: #f8fafc; border-color: var(--primary); }

        /* Tabs */
        .tabs-container { display: flex; gap: 1rem; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; overflow-x: auto;}
        .tab-btn { padding: 0.75rem 1.5rem; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-muted); font-weight: 600; cursor: pointer; white-space: nowrap; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* Analysis Specifics */
        .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
        .chart-container { position: relative; height: 250px; width: 100%; }
        .stat-box { background: #f8fafc; padding: 1rem; border-radius: var(--radius-md); text-align: center; border: 1px solid var(--border); }
        .stat-num { font-size: 1.5rem; font-weight: 700; color: var(--secondary); }
        .stat-lbl { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-top: 0.25rem; }
        
        .axis-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed var(--border); }
        .axis-inputs input { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- Modale de Confirmation -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-bottom:0.5rem; color:var(--secondary);">Confirmation</h3>
            <p id="modal-msg" style="color:var(--text-muted);">√ätes-vous s√ªr ?</p>
            <div class="flex-end" style="margin-top: 1.5rem;">
                <button class="btn btn-secondary" id="modal-cancel">Annuler</button>
                <button class="btn btn-danger" id="modal-confirm">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Modale d'Import Multiple -->
    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="color:var(--primary);">üì• Fusionner (Import Multiple)</h3>
            <p class="text-sm" style="margin-bottom:1rem;">S√©lectionnez un ou plusieurs fichiers JSON de collecteurs. Les doublons seront ignor√©s.</p>
            
            <input type="file" id="import-file" accept=".json" multiple class="hidden">
            <div class="file-drop-area" onclick="document.getElementById('import-file').click()">
                <div style="font-size:2rem;">üìÇ</div>
                <p>Cliquez pour s√©lectionner les fichiers</p>
            </div>
            
            <div id="import-status" class="text-sm" style="margin-top:1rem; color:var(--info);"></div>

            <div class="flex-end" style="margin-top:1rem;">
                <button class="btn btn-secondary" onclick="closeImportModal()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modale Import Structure Questionnaire -->
    <div id="import-struct-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="color:var(--primary);">üì• Importer un Questionnaire</h3>
            <p class="text-sm" style="margin-bottom:1rem;">Chargez un fichier de structure (.json).</p>
            <input type="file" id="import-struct-file" accept=".json" class="hidden">
            <div class="file-drop-area" onclick="document.getElementById('import-struct-file').click()">
                <div style="font-size:2rem;">üìù</div>
                <p>S√©lectionner un fichier Structure</p>
            </div>
            <div class="flex-end">
                <button class="btn btn-secondary" onclick="closeStructModal()">Fermer</button>
            </div>
        </div>
    </div>

    <nav class="navbar">
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--primary)"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
            Sahel<span>Stats</span> <span style="font-weight:300; font-size:0.8em; margin-left:5px; color:var(--text-muted)">Pro Ultimate</span>
        </div>
        <div class="nav-profile">
            <span id="nav-mode-label">Mode Connect√©</span>
            <div class="avatar">üë®‚Äçüî¨</div>
        </div>
    </nav>

    <div id="app" class="main-container"></div>

    <script>
        // --- Configuration ---
        const embeddedSurveyData = null; 
        const isLockedMode = false; 

        // --- √âtat Global ---
        let state = {
            view: 'list',
            surveys: [],
            currentSurvey: null,
            responses: {},
            formData: {},
            resultsTab: 'data', 
            isOfflineMode: false,
            collectorName: '',
            filterCollector: '', // Filtre actif
            activeCharts: []     // Pour nettoyer les charts
        };

        // --- Drag & Drop Globals ---
        let draggedQ = null; 

        // --- Initialisation ---
        function init() {
            if (embeddedSurveyData || isLockedMode) {
                state.isOfflineMode = true;
                if (embeddedSurveyData) {
                    state.surveys = [embeddedSurveyData];
                    state.currentSurvey = embeddedSurveyData;
                } else {
                    loadData();
                }
                
                if(state.currentSurvey) {
                    const savedResponses = localStorage.getItem(`responses_${state.currentSurvey.id}`);
                    state.responses = savedResponses ? { [state.currentSurvey.id]: JSON.parse(savedResponses) } : { [state.currentSurvey.id]: [] };
                }

                state.collectorName = localStorage.getItem('collector_name') || '';
                document.getElementById('nav-mode-label').textContent = isLockedMode ? "Mode Collecteur (Verrouill√©)" : "Mode Autonome";
                navigateTo('offline-home');
            } else {
                loadData();
                render();
            }
        }

        function loadData() {
            const savedSurveys = localStorage.getItem('surveys');
            const savedResponses = localStorage.getItem('responses');
            if (savedSurveys) state.surveys = JSON.parse(savedSurveys);
            if (savedResponses) state.responses = JSON.parse(savedResponses);
        }

        function saveData() {
            if (state.isOfflineMode) {
                localStorage.setItem(`responses_${state.currentSurvey.id}`, JSON.stringify(state.responses[state.currentSurvey.id]));
                localStorage.setItem('collector_name', state.collectorName);
            } else {
                localStorage.setItem('surveys', JSON.stringify(state.surveys));
                localStorage.setItem('responses', JSON.stringify(state.responses));
            }
        }

        function navigateTo(view, surveyId = null) {
            if (!state.isOfflineMode && !isLockedMode && (state.view === 'create') && view === 'list') {
                saveDraft();
            }

            if (surveyId) {
                const targetSurvey = state.surveys.find(s => s.id === surveyId);
                if (!state.isOfflineMode && targetSurvey && view === 'collect' && targetSurvey.status === 'draft') {
                    showToast("Enqu√™te en brouillon. Veuillez la publier pour collecter.", "error");
                    return; 
                }
                state.currentSurvey = targetSurvey;
                if(!state.currentSurvey.status) state.currentSurvey.status = 'published';
            }
            
            state.view = view;
            state.formData = {};
            state.filterCollector = ''; // Reset filter on nav
            window.scrollTo(0,0);
            render();
        }

        window.switchResultTab = (tab) => {
            state.resultsTab = tab;
            render();
        };

        window.updateCell = (respId, qId, cell, type) => {
            const val = cell.innerText;
            const surveyId = state.currentSurvey.id;
            const resp = state.responses[surveyId].find(r => r.id === respId);
            if (resp) {
                if (type === 'number') { const num = parseFloat(val); resp.data[qId] = isNaN(num) ? val : num; } 
                else { resp.data[qId] = val; }
                saveData();
                showToast("Valeur mise √† jour");
                render(); 
            }
        };

        window.updateAxisLabel = (qId, axis, value) => {
            const sec = state.currentSurvey.sections.find(s => s.questions.some(q => q.id === qId));
            const q = sec.questions.find(q => q.id === qId);
            if (!q.chartOptions) q.chartOptions = {};
            q.chartOptions[axis] = value;
            saveData();
        };

        function createNewSurvey() {
            const newSurvey = {
                id: Date.now().toString(),
                title: 'Nouvelle enqu√™te',
                description: '',
                sections: [{ id: Date.now().toString(), name: 'Section Principale', questions: [] }],
                createdAt: new Date().toISOString(),
                status: 'draft'
            };
            state.currentSurvey = newSurvey;
            navigateTo('create');
        }

        function saveDraft() {
            if (!state.currentSurvey) return;
            const existingIdx = state.surveys.findIndex(s => s.id === state.currentSurvey.id);
            if (existingIdx >= 0) state.surveys[existingIdx] = state.currentSurvey;
            else state.surveys.push(state.currentSurvey);
            saveData();
            if (state.currentSurvey.status === 'draft') showToast("Brouillon sauvegard√©", "warning");
        }

        function submitResponse() {
            if (!state.collectorName && state.isOfflineMode) {
                showToast("Veuillez renseigner votre nom de collecteur en haut du formulaire.", "error");
                document.getElementById('collector-name-input').focus();
                return;
            }
            const allQuestions = state.currentSurvey.sections.flatMap(s => s.questions);
            for (const q of allQuestions) {
                if (q.required) {
                    const val = state.formData[q.id];
                    if (val === undefined || val === "" || (Array.isArray(val) && val.length === 0)) {
                        showToast(`Question obligatoire manquante : "${q.label}"`, 'error');
                        return;
                    }
                }
            }
            const surveyId = state.currentSurvey.id;
            if (!state.responses[surveyId]) state.responses[surveyId] = [];
            state.responses[surveyId].push({
                id: Date.now().toString(),
                timestamp: new Date().toISOString(),
                collector: state.collectorName || 'Admin',
                data: state.formData
            });
            saveData();
            showToast("R√©ponse enregistr√©e !");
            setTimeout(() => { state.isOfflineMode ? navigateTo('offline-home') : navigateTo('list'); }, 1000);
        }

        // --- GESTION IMPORT / EXPORT STRUCTURE & DATA ---

        function exportSurveyStructure(surveyId) {
            const survey = state.surveys.find(s => s.id === surveyId);
            const fileName = `STRUCT_${survey.title.replace(/[^a-z0-9]/gi, '_')}.json`;
            downloadFile(JSON.stringify(survey, null, 2), fileName, 'application/json');
            showToast("Structure export√©e.");
        }

        function openImportStructModal() { document.getElementById('import-struct-modal').classList.remove('hidden'); }
        function closeStructModal() { document.getElementById('import-struct-modal').classList.add('hidden'); document.getElementById('import-struct-file').value = ''; }

        document.addEventListener('DOMContentLoaded', () => {
            const structInput = document.getElementById('import-struct-file');
            if(structInput) {
                structInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const newSurvey = JSON.parse(ev.target.result);
                            if(!newSurvey.sections || !newSurvey.title) throw new Error("Format invalide");
                            newSurvey.id = Date.now().toString(); 
                            newSurvey.title += " (Import)";
                            state.surveys.push(newSurvey);
                            saveData();
                            render();
                            showToast("Questionnaire import√© avec succ√®s");
                        } catch(err) { showToast("Fichier structure invalide", "error"); }
                        closeStructModal();
                    };
                    reader.readAsText(file);
                });
            }
        });

        function exportSyncData() {
            const sId = state.currentSurvey.id;
            const responses = state.responses[sId] || [];
            if (responses.length === 0) { showToast("Aucune r√©ponse √† exporter.", "warning"); return; }
            
            const isMaster = !state.isOfflineMode;
            const label = isMaster ? "MASTER_DATA" : state.collectorName;

            const syncPacket = {
                type: 'sahelstats_sync',
                surveyId: sId,
                collector: label,
                exportedAt: new Date().toISOString(),
                responses: responses
            };
            const fileName = `SYNC_${state.currentSurvey.title.substring(0,10)}_${label}_${responses.length}rep.json`;
            downloadFile(JSON.stringify(syncPacket, null, 2), fileName, 'application/json');
            showToast(isMaster ? "Donn√©es globales export√©es." : "Paquet sync g√©n√©r√©.");
        }

        function triggerImport() { document.getElementById('import-modal').classList.remove('hidden'); }
        function closeImportModal() { document.getElementById('import-modal').classList.add('hidden'); document.getElementById('import-file').value = ''; document.getElementById('import-status').innerHTML=''; }

        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('import-file');
            if(fileInput) {
                fileInput.addEventListener('change', async (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length === 0) return;

                    let totalAdded = 0;
                    let totalSkipped = 0;
                    let errors = 0;

                    const statusDiv = document.getElementById('import-status');
                    statusDiv.innerHTML = "Traitement en cours...";

                    for (const file of files) {
                        try {
                            const text = await readFileAsync(file);
                            const packet = JSON.parse(text);
                            const result = processSyncPacket(packet, true); 
                            if(result) {
                                totalAdded += result.added;
                                totalSkipped += result.skipped;
                            } else {
                                errors++;
                            }
                        } catch (err) {
                            errors++;
                        }
                    }

                    saveData();
                    render();
                    closeImportModal();
                    
                    let msg = `Import termin√©: ${totalAdded} ajout√©s, ${totalSkipped} doublons.`;
                    if(errors > 0) msg += ` ${errors} erreurs.`;
                    showToast(msg, totalAdded > 0 ? "success" : "warning");
                });
            }
        });

        function readFileAsync(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function processSyncPacket(packet, silent = false) {
            if (packet.type !== 'sahelstats_sync') { if(!silent) showToast("Format invalide", "error"); return null; }
            if (packet.surveyId !== state.currentSurvey.id) { if(!silent) showToast("Mauvaise enqu√™te", "error"); return null; }

            const currentResponses = state.responses[state.currentSurvey.id] || [];
            let addedCount = 0;
            let skippedCount = 0;

            packet.responses.forEach(newResp => {
                const exists = currentResponses.find(r => r.id === newResp.id);
                if (!exists) { currentResponses.push(newResp); addedCount++; } else { skippedCount++; }
            });

            state.responses[state.currentSurvey.id] = currentResponses;
            
            if(!silent) {
                saveData();
                render();
                let msg = `Fusion: ${addedCount} ajouts, ${skippedCount} doublons`;
                showToast(msg, addedCount > 0 ? "success" : "warning");
            }
            return { added: addedCount, skipped: skippedCount };
        }

        // --- Exports Classiques ---
        function getCleanData(surveyId) {
            const survey = state.currentSurvey || state.surveys.find(s => s.id === surveyId);
            const responses = state.responses[survey.id] || [];
            
            // Appliquer le filtre si pr√©sent
            let filteredResponses = responses;
            if(state.filterCollector) {
                filteredResponses = responses.filter(r => (r.collector || 'Admin') === state.filterCollector);
            }

            const allQuestions = survey.sections.flatMap(s => s.questions);
            return { survey, responses: filteredResponses, allQuestions };
        }

        function exportToExcel(surveyId) {
            const { survey, responses, allQuestions } = getCleanData(surveyId);
            if (!responses.length) { showToast("Rien √† exporter", "error"); return; }
            const data = responses.map(r => {
                let row = { 'ID': r.id, 'Collecteur': r.collector || 'N/A', 'Date': new Date(r.timestamp).toLocaleString() };
                allQuestions.forEach(q => {
                    let v = r.data[q.id];
                    row[q.label] = Array.isArray(v) ? v.join('; ') : v;
                });
                return row;
            });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Donn√©es");
            XLSX.writeFile(wb, `Export_${survey.title}.xlsx`);
        }

        function exportToCSV(surveyId) {
            const { survey, responses, allQuestions } = getCleanData(surveyId);
            if (!responses.length) return;
            const headers = ['ID', 'Collecteur', 'Date', ...allQuestions.map(q => q.label)];
            const rows = responses.map(r => {
                const vals = allQuestions.map(q => {
                    let v = r.data[q.id];
                    if (Array.isArray(v)) v = v.join('; ');
                    return `"${String(v||'').replace(/"/g, '""')}"`;
                });
                return [r.id, r.collector||'', new Date(r.timestamp).toLocaleString(), ...vals].join(',');
            });
            downloadFile([headers.join(','), ...rows].join('\n'), `Export_${survey.title}.csv`, 'text/csv');
        }

        // --- Helper Quantiles ---
        function getQuantile(sortedArr, q) {
            const pos = (sortedArr.length - 1) * q;
            const base = Math.floor(pos);
            const rest = pos - base;
            if ((sortedArr[base + 1] !== undefined)) {
                return sortedArr[base] + rest * (sortedArr[base + 1] - sortedArr[base]);
            } else {
                return sortedArr[base];
            }
        }

        function exportToWord(surveyId) {
            const { survey, responses, allQuestions } = getCleanData(surveyId);
            if (responses.length === 0) { showToast("Aucune donn√©e.", "error"); return; }
            if (state.resultsTab !== 'analysis') { showToast("Allez sur l'onglet 'Analyse' d'abord.", "info"); return; }
            
            showToast("G√©n√©ration Word...");
            const titleSuffix = state.filterCollector ? `<br><span style="font-size:0.6em; color:#666;">Filtre : ${state.filterCollector}</span>` : "";
            
            let htmlBody = `<div style="font-family: Arial, padding: 20px;"><h1 style="color:#4F46E5;text-align:center;">${survey.title}${titleSuffix}</h1><p style="text-align:center;">Total: ${responses.length}</p><hr/>`;
            
            allQuestions.forEach((q, idx) => {
                htmlBody += `<h2 style="color:#1e293b;margin-top:30px;border-bottom:2px solid #e2e8f0;">${idx+1}. ${q.label}</h2>`;
                const data = responses.map(r => r.data[q.id]).filter(v => v !== undefined && v !== "");
                
                if (['select', 'radio', 'checkbox'].includes(q.type)) {
                    const canvas = document.getElementById(`chart-${q.id}`);
                    if (canvas) {
                        try { htmlBody += `<div style="text-align:center;"><img src="${canvas.toDataURL("image/png")}" width="500"/></div>`; } 
                        catch(e) {}
                    }
                } 
                else if (q.type === 'number') {
                    const nums = data.map(v => parseFloat(v)).filter(v => !isNaN(v));
                    if (nums.length > 0) {
                        const sum = nums.reduce((a,b)=>a+b, 0); 
                        const avg = (sum / nums.length).toFixed(2);
                        nums.sort((a,b) => a-b);
                        const min = nums[0];
                        const max = nums[nums.length-1];
                        const q1 = getQuantile(nums, 0.25).toFixed(2);
                        const q2 = getQuantile(nums, 0.50).toFixed(2); // M√©diane
                        const q3 = getQuantile(nums, 0.75).toFixed(2);

                        htmlBody += `
                        <table border="1" cellpadding="8" cellspacing="0" style="width:100%; border-collapse: collapse; font-family: Arial; margin-top:10px;">
                            <tr style="background-color:#f1f5f9;">
                                <th>Moyenne</th><th>Somme</th><th>Min</th><th>Q1</th><th>M√©diane (Q2)</th><th>Q3</th><th>Max</th>
                            </tr>
                            <tr>
                                <td align="center">${avg}</td><td align="center">${sum}</td><td align="center">${min}</td>
                                <td align="center">${q1}</td><td align="center">${q2}</td><td align="center">${q3}</td>
                                <td align="center">${max}</td>
                            </tr>
                        </table>`;
                    } else {
                        htmlBody += `<p>Aucune donn√©e num√©rique valide.</p>`;
                    }
                } else {
                    htmlBody += `<ul>${data.slice(0, 10).map(t=>`<li>${t}</li>`).join('')}</ul>`;
                    if(data.length > 10) htmlBody += `<p style="font-style:italic;">... et ${data.length - 10} autres r√©ponses.</p>`;
                }
            });
            htmlBody += `</div>`;
            const blob = new Blob(['\ufeff', "<html xmlns:w='urn:schemas-microsoft-com:office:word'><body>" + htmlBody + "</body></html>"], { type: 'application/msword' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `Rapport_${survey.title}.doc`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        // --- Export Collecteurs ---
        function exportCollectorsToWord() {
            const responses = state.responses[state.currentSurvey.id] || [];
            if(responses.length === 0) { showToast("Aucune donn√©e.", "error"); return; }

            const counts = {};
            responses.forEach(r => { const c = r.collector || 'Inconnu'; counts[c] = (counts[c] || 0) + 1; });
            const labels = Object.keys(counts); const data = Object.values(counts);

            const canvas = document.getElementById('coll-chart');
            let imgTag = "";
            if(canvas) {
                try { imgTag = `<div style="text-align:center; margin:20px;"><img src="${canvas.toDataURL("image/png")}" width="600"/></div>`; } 
                catch(e){}
            }

            let tableHtml = `
            <table border="1" cellpadding="8" cellspacing="0" style="width:100%; border-collapse: collapse; font-family: Arial;">
                <tr style="background-color:#f1f5f9;"><th>Collecteur</th><th>Nombre de r√©ponses</th><th>Pourcentage</th></tr>
            `;
            labels.forEach((l, i) => {
                const pct = ((data[i] / responses.length) * 100).toFixed(1);
                tableHtml += `<tr><td>${l}</td><td align="center">${data[i]}</td><td align="center">${pct}%</td></tr>`;
            });
            tableHtml += `</table>`;

            let htmlBody = `
            <div style="font-family: Arial, padding: 20px;">
                <h1 style="color:#4F46E5;text-align:center;">Rapport Performance Collecteurs</h1>
                <h2 style="text-align:center; color:#666;">${state.currentSurvey.title}</h2>
                <hr/>
                ${imgTag}
                <h3>D√©tail des contributions</h3>
                ${tableHtml}
            </div>`;

            const blob = new Blob(['\ufeff', "<html xmlns:w='urn:schemas-microsoft-com:office:word'><body>" + htmlBody + "</body></html>"], { type: 'application/msword' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `Performance_${state.currentSurvey.title}.doc`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type + ';charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a'); link.href = url; link.download = filename; link.click(); URL.revokeObjectURL(url);
        }

        function downloadOfflineApp(surveyId) {
            const survey = state.surveys.find(s => s.id === surveyId);
            const html = document.documentElement.outerHTML;
            const finalHtml = html
                .replace("const embeddedSurveyData = null;", `const embeddedSurveyData = ${JSON.stringify(survey)};`)
                .replace("const isLockedMode = false;", "const isLockedMode = true;");
            downloadFile(finalHtml, `App_Collecte_${survey.title.replace(/[^a-z0-9]/gi, '_')}.html`, 'text/html');
            showToast("App Collecteur t√©l√©charg√©e !");
        }

        function showToast(msg, type='success') {
            const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = `<span>${type==='success'?'‚úÖ':(type==='error'?'‚ö†Ô∏è':'‚ÑπÔ∏è')}</span> ${msg}`;
            document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 3000);
        }
        function showConfirm(msg, cb) {
            document.getElementById('modal-msg').textContent = msg;
            document.getElementById('confirm-modal').classList.remove('hidden');
            document.getElementById('modal-confirm').onclick = () => { cb(); document.getElementById('confirm-modal').classList.add('hidden'); };
            document.getElementById('modal-cancel').onclick = () => document.getElementById('confirm-modal').classList.add('hidden');
        }

        // --- Rendu Vues ---
        function render() {
            const app = document.getElementById('app'); app.innerHTML = '';
            const views = {
                'list': renderList, 'create': renderCreate, 'collect': renderCollect,
                'preview': renderPreview, 'results': renderResults, 'offline-home': renderOfflineHome
            };
            if(views[state.view]) views[state.view](app);
        }

        function renderList(app) {
            app.innerHTML = `
                <div class="flex-between" style="margin-bottom:2rem;">
                    <div><h3>R√©alis√© par Dr. MAGAGI ALI Bachir</h3><h1>Mes Enqu√™tes</h1><p class="subtitle">Gestion centrale des enqu√™tes.</p></div>
                    <div style="display:flex; gap:0.5rem;">
                        <button class="btn btn-secondary" onclick="openImportStructModal()">üì• Importer Une Enqu√™te</button>
                        <button class="btn btn-primary" onclick="createNewSurvey()">+ Nouvelle Enqu√™te</button>
                    </div>
                </div>
                ${state.surveys.length === 0 ? '<div class="card" style="text-align:center; padding:3rem;">Aucune enqu√™te.</div>' : 
                `<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(320px, 1fr)); gap:1.5rem;">
                    ${state.surveys.map(s => {
                        const count = (state.responses[s.id]||[]).length;
                        return `
                        <div class="card" style="border-top:4px solid var(--primary); height:100%; display:flex; flex-direction:column;">
                            <div style="flex:1;">
                                <div class="flex-between"><h3 style="color:var(--secondary); margin-bottom:0.5rem;">${s.title}</h3>${s.status==='draft'?'<span class="badge badge-draft">Brouillon</span>':'<span class="badge badge-published">Publi√©</span>'}</div>
                                <p class="text-sm" style="color:var(--text-muted); margin-bottom:1rem;">${s.description||'...'}</p>
                                <div style="background:#f8fafc; padding:0.5rem; border-radius:4px; margin-bottom:1rem; font-size:0.85rem;"><strong>${count}</strong> R√©ponses fusionn√©es</div>
                            </div>
                            <div class="flex-end">
                                ${s.status==='draft' ? '<button class="btn btn-ghost" disabled style="opacity:0.5">üö´</button>' : `<button class="btn btn-secondary btn-sm" onclick="navigateTo('collect', '${s.id}')">Saisir</button>`}
                                <button class="btn btn-secondary btn-sm" onclick="navigateTo('results', '${s.id}')">R√©sultats</button>
                                <button class="btn btn-ghost" onclick="navigateTo('create', '${s.id}')">‚úèÔ∏è</button>
                                <button class="btn btn-ghost" onclick="exportSurveyStructure('${s.id}')" title="Exporter Structure">üì§</button>
                                ${s.status!=='draft' ? `<button class="btn btn-ghost" onclick="downloadOfflineApp('${s.id}')" title="App Collecteur">üì≤</button>` : ''}
                                <button class="btn btn-ghost" style="color:var(--danger)" onclick="deleteSurvey('${s.id}')">üóëÔ∏è</button>
                            </div>
                        </div>`;
                    }).join('')}
                </div>`}
            `;
            window.deleteSurvey = (id) => showConfirm("Supprimer l'enqu√™te et TOUTES les donn√©es ?", () => {
                state.surveys = state.surveys.filter(s => s.id !== id); delete state.responses[id]; saveData(); render();
            });
        }

        function renderCreate(app) {
            const s = state.currentSurvey;
            app.innerHTML = `
                <div class="flex-between" style="margin-bottom:1.5rem;">
                    <button class="btn btn-secondary" onclick="navigateTo('list')">‚Üê Retour</button>
                    <h1>${s.id ? '√âditer' : 'Cr√©er'}</h1>
                    <div class="flex-end">
                        <button class="btn btn-info" onclick="navigateTo('preview')">üëÅÔ∏è Pr√©visualiser</button>
                        <button class="btn btn-primary" onclick="saveAndPublish()">üíæ Enregistrer & Publier</button>
                    </div>
                </div>
                <div class="card">
                    <div class="input-group"><label>Titre</label><input class="form-control" value="${s.title}" oninput="state.currentSurvey.title=this.value"></div>
                    <div class="input-group"><label>Description</label><textarea class="form-control" oninput="state.currentSurvey.description=this.value">${s.description}</textarea></div>
                </div>
                <div id="sections-editor"></div>
                <button class="btn btn-secondary" style="width:100%; border-style:dashed;" onclick="addSection()">+ Ajouter Section</button>
            `;
            renderSectionsEditor();
            window.saveAndPublish = () => { state.currentSurvey.status = 'published'; saveDraft(); showToast("Publi√© !"); navigateTo('list'); };
        }

        // --- DnD Implementation ---
        window.handleDragStart = (e, secId, qIndex) => {
            draggedQ = { secId, qIndex };
            e.dataTransfer.effectAllowed = 'move';
            e.target.style.opacity = '0.5';
        };
        window.handleDragEnd = (e) => {
            e.target.style.opacity = '1';
            document.querySelectorAll('.card').forEach(el => el.classList.remove('drag-over'));
        };
        window.handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
        window.handleDragEnter = (e) => { e.target.closest('.q-card')?.classList.add('drag-over'); };
        window.handleDragLeave = (e) => { e.target.closest('.q-card')?.classList.remove('drag-over'); };
        
        window.handleDrop = (e, targetSecId, targetIndex) => {
            e.preventDefault();
            if (!draggedQ) return;
            const sourceSec = state.currentSurvey.sections.find(s => s.id === draggedQ.secId);
            const targetSec = state.currentSurvey.sections.find(s => s.id === targetSecId);
            const [movedQ] = sourceSec.questions.splice(draggedQ.qIndex, 1);
            let finalIndex = targetIndex;
            targetSec.questions.splice(finalIndex, 0, movedQ);
            draggedQ = null;
            saveDraft();
            renderSectionsEditor();
        };

        function renderSectionsEditor() {
            const container = document.getElementById('sections-editor');
            const types = [{v:'text',l:'Texte'},{v:'number',l:'Nombre'},{v:'select',l:'Liste'},{v:'radio',l:'Radio'},{v:'checkbox',l:'Cases'},{v:'date',l:'Date'}];
            
            container.innerHTML = state.currentSurvey.sections.map(sec => `
                <div class="card" style="border-left:4px solid var(--text-muted);" ondragover="handleDragOver(event)" ondrop="handleDrop(event, '${sec.id}', ${sec.questions.length})">
                    <div class="flex-between" style="margin-bottom:1rem;">
                        <input class="form-control" style="font-weight:bold; width:auto;" value="${sec.name}" onchange="updateSec('${sec.id}', this.value)">
                        <button class="btn btn-ghost" style="color:var(--danger)" onclick="delSec('${sec.id}')">üóëÔ∏è</button>
                    </div>
                    ${sec.questions.map((q, idx) => `
                        <div class="q-card" style="background:#f8fafc; padding:1rem; margin-bottom:0.5rem; border:1px solid var(--border); border-radius:4px; display:flex; gap:0.5rem; align-items:center;"
                             draggable="true" 
                             ondragstart="handleDragStart(event, '${sec.id}', ${idx})"
                             ondragend="handleDragEnd(event)"
                             ondragenter="handleDragEnter(event)"
                             ondragleave="handleDragLeave(event)"
                             ondrop="event.stopPropagation(); handleDrop(event, '${sec.id}', ${idx})">
                            
                            <div class="drag-handle">‚ò∞</div>
                            
                            <div style="flex:1;">
                                <div class="flex-between" style="gap:0.5rem; margin-bottom:0.5rem;">
                                    <input class="form-control" value="${q.label}" placeholder="Question" onchange="updQ('${sec.id}','${q.id}','label',this.value)">
                                    <select class="form-control" style="width:120px;" onchange="updQ('${sec.id}','${q.id}','type',this.value)">
                                        ${types.map(t => `<option value="${t.v}" ${q.type===t.v?'selected':''}>${t.l}</option>`).join('')}
                                    </select>
                                    <label style="display:flex; align-items:center; gap:0.25rem; font-size:0.85rem; white-space:nowrap; cursor:pointer;">
                                        <input type="checkbox" ${q.required?'checked':''} onchange="updQ('${sec.id}','${q.id}','required',this.checked)"> Obligatoire
                                    </label>
                                    <button class="btn btn-ghost" style="color:red;" onclick="delQ('${sec.id}','${q.id}')">‚úï</button>
                                </div>
                                ${['select','radio','checkbox'].includes(q.type) ? `<input class="form-control" placeholder="Options (sep virgule)" value="${q.options.join(',')}" onchange="updQ('${sec.id}','${q.id}','options',this.value)">` : ''}
                            </div>
                        </div>
                    `).join('')}
                    <button class="btn btn-secondary btn-sm" onclick="addQ('${sec.id}')">+ Question</button>
                </div>
            `).join('');

            window.addSection = () => { state.currentSurvey.sections.push({id:Date.now().toString(), name:'Nouvelle Section', questions:[]}); renderSectionsEditor(); };
            window.delSec = (id) => { state.currentSurvey.sections = state.currentSurvey.sections.filter(s=>s.id!==id); renderSectionsEditor(); };
            window.updateSec = (id,v) => { state.currentSurvey.sections.find(s=>s.id===id).name=v; };
            window.addQ = (sid) => { state.currentSurvey.sections.find(s=>s.id===sid).questions.push({id:Date.now().toString(), type:'text', label:'', options:[], required:false}); renderSectionsEditor(); };
            window.delQ = (sid,qid) => { const s=state.currentSurvey.sections.find(s=>s.id===sid); s.questions=s.questions.filter(q=>q.id!==qid); renderSectionsEditor(); };
            window.updQ = (sid,qid,f,v) => { const q=state.currentSurvey.sections.find(s=>s.id===sid).questions.find(q=>q.id===qid); if(f==='options') q.options=v.split(',').map(o=>o.trim()); else q[f]=v; if(f==='type') renderSectionsEditor(); };
        }

        function renderPreview(app) {
            app.innerHTML = `
                <div style="max-width:800px; margin:0 auto;">
                    <div class="card flex-between" style="background:var(--primary-light); border:1px solid var(--primary); margin-bottom:2rem;">
                        <div style="display:flex;align-items:center;gap:1rem;">
                            <div style="font-size:1.5rem;">üëÅÔ∏è</div>
                            <div><h3 style="color:var(--primary-dark);margin:0;">Pr√©visualisation</h3></div>
                        </div>
                        <button class="btn btn-primary" onclick="navigateTo('create')">‚úèÔ∏è Retour</button>
                    </div>
                    ${renderSurveyForm(state.currentSurvey, true)}
                </div>
            `;
        }

        function renderCollect(app) {
            const s = state.currentSurvey;
            app.innerHTML = `
                <div style="max-width:800px; margin:0 auto;">
                    <div class="flex-between" style="margin-bottom:1rem;">
                        <button class="btn btn-ghost" onclick="state.isOfflineMode ? navigateTo('offline-home') : navigateTo('list')">‚Üê Annuler</button>
                        <span>Mode Collecte</span>
                    </div>
                    <div class="card" style="border-left:4px solid var(--info);">
                        <label>üë§ Collecteur</label>
                        <input type="text" id="collector-name-input" class="form-control" placeholder="Nom ou code" value="${state.collectorName}" oninput="state.collectorName=this.value">
                    </div>
                    <div class="card" style="text-align:center;"><h1>${s.title}</h1><p>${s.description}</p></div>
                    <form id="collect-form">
                        ${renderSurveyForm(s, false)}
                        <div style="margin-top:2rem;">
                            <button type="button" class="btn btn-primary" style="width:100%; padding:1rem;" onclick="submitResponse()">Envoyer la r√©ponse</button>
                        </div>
                    </form>
                </div>
            `;
            attachFormListeners();
        }

        function renderSurveyForm(survey, disabled) {
            return survey.sections.map(sec => `
                <h3 style="margin:1.5rem 0 1rem; color:var(--primary);">${sec.name}</h3>
                <div class="card">
                    ${sec.questions.map(q => {
                        const req = q.required ? '<span style="color:red">*</span>' : '';
                        let input = ''; const dis = disabled ? 'disabled' : '';
                        if(['text','number','date','email'].includes(q.type)) input = `<input type="${q.type}" class="form-control" data-qid="${q.id}" ${dis}>`;
                        else if(q.type==='textarea') input = `<textarea class="form-control" rows="3" data-qid="${q.id}" ${dis}></textarea>`;
                        else if(q.type==='select') input = `<select class="form-control" data-qid="${q.id}" ${dis}><option value="">--</option>${q.options.map(o=>`<option>${o}</option>`).join('')}</select>`;
                        else if(q.type==='radio') input = q.options.map(o=>`<label style="display:block;"><input type="radio" name="${q.id}" value="${o}" data-qid="${q.id}" ${dis}> ${o}</label>`).join('');
                        else if(q.type==='checkbox') input = q.options.map(o=>`<label style="display:block;"><input type="checkbox" value="${o}" data-qid="${q.id}" data-is-check="true" ${dis}> ${o}</label>`).join('');
                        return `<div class="input-group"><label>${q.label} ${req}</label>${input}</div>`;
                    }).join('')}
                </div>
            `).join('');
        }

        function attachFormListeners() {
            const form = document.getElementById('collect-form'); if(!form) return;
            const focusNext = (cur) => {
                const els = Array.from(form.querySelectorAll('input, select, textarea, button'));
                const idx = els.indexOf(cur);
                if (idx > -1 && idx < els.length - 1) els[idx + 1].focus();
            };
            form.addEventListener('keydown', e => { if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && e.target.type !== 'submit') { e.preventDefault(); focusNext(e.target); } });
            form.addEventListener('change', e => {
                const t = e.target; const qid = t.dataset.qid;
                if (t.tagName === 'SELECT' || t.type === 'radio') focusNext(t);
                if(!qid) return;
                if(t.type==='checkbox') {
                    if(!state.formData[qid]) state.formData[qid]=[];
                    if(t.checked) state.formData[qid].push(t.value); else state.formData[qid] = state.formData[qid].filter(v=>v!==t.value);
                } else if(t.type==='number') { state.formData[qid] = t.value === "" ? "" : parseFloat(t.value);
                } else if(t.type==='radio') { if(t.checked) state.formData[qid] = t.value;
                } else { state.formData[qid] = t.value; }
            });
            form.addEventListener('input', e => { if(e.target.type !== 'checkbox' && e.target.type !== 'radio' && e.target.tagName !== 'SELECT') { const qid = e.target.dataset.qid; if(qid) state.formData[qid] = e.target.value; } });
        }

        function renderResults(app) {
            const responses = state.responses[state.currentSurvey.id] || [];
            app.innerHTML = `
                <div class="flex-between" style="margin-bottom:1rem;">
                    <button class="btn btn-secondary" onclick="state.isOfflineMode ? navigateTo('offline-home') : navigateTo('list')">‚Üê Retour</button>
                    <h1>R√©sultats</h1>
                    <div class="flex-end">
                        <button class="btn btn-warning" onclick="triggerImport()">üì• Fusionner (Multi)</button>
                        <button class="btn btn-secondary" onclick="exportSyncData()">üì§ Exporter (Sync Global)</button>
                        <button class="btn btn-success" onclick="exportToExcel('${state.currentSurvey.id}')">Excel</button>
                    </div>
                </div>
                <div class="tabs-container">
                    <button class="tab-btn ${state.resultsTab === 'data' ? 'active' : ''}" onclick="switchResultTab('data')">üìã Donn√©es Brutes</button>
                    <button class="tab-btn ${state.resultsTab === 'analysis' ? 'active' : ''}" onclick="switchResultTab('analysis')">üìà Analyse Graphique</button>
                    <button class="tab-btn ${state.resultsTab === 'collectors' ? 'active' : ''}" onclick="switchResultTab('collectors')">üë• Performance Collecteurs</button>
                </div>
                ${responses.length === 0 ? '<div class="card" style="text-align:center; padding:2rem;">Aucune donn√©e.</div>' : (
                    state.resultsTab === 'data' ? renderDataTable(responses) : (state.resultsTab === 'analysis' ? renderAnalysis(responses) : renderCollectorAnalysis(responses))
                )}
            `;
        }

        function renderDataTable(responses) {
            const allQ = state.currentSurvey.sections.flatMap(s => s.questions);
            return `
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>#</th><th>Collecteur</th><th>Date</th>${allQ.map(q=>`<th>${q.label}</th>`).join('')}</tr></thead>
                        <tbody>
                            ${responses.map((r,i) => `
                                <tr><td>${i+1}</td><td><span class="badge" style="background:#e0e7ff; color:#4338ca;">${r.collector || 'Admin'}</span></td><td>${new Date(r.timestamp).toLocaleDateString()}</td>
                                ${allQ.map(q => { let v=r.data[q.id]; let d=Array.isArray(v)?v.join(','):(v??''); return `<td contenteditable="true" onblur="updateCell('${r.id}', '${q.id}', this, '${q.type}')">${d}</td>`; }).join('')}
                                </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Nouvelle logique de filtrage
        window.filterAnalysis = (collector) => {
            state.filterCollector = collector;
            // R√©cup√©rer et filtrer les r√©ponses
            const allResp = state.responses[state.currentSurvey.id] || [];
            const filtered = collector ? allResp.filter(r => (r.collector || 'Admin') === collector) : allResp;
            const allQ = state.currentSurvey.sections.flatMap(s => s.questions);
            // Relancer les graphiques
            initCharts(filtered, allQ);
        };

        function renderAnalysis(responses) {
            const allQ = state.currentSurvey.sections.flatMap(s => s.questions);
            
            // Calculer les collecteurs uniques pour le dropdown
            const collectors = [...new Set(responses.map(r => r.collector || 'Admin'))].sort();

            // Initialiser avec toutes les donn√©es (ou le filtre actuel si on re-render)
            setTimeout(() => {
                if(state.filterCollector) {
                    window.filterAnalysis(state.filterCollector);
                } else {
                    initCharts(responses, allQ);
                }
            }, 100);

            return `
                <div class="flex-between" style="margin-bottom:1rem; align-items: flex-end;">
                    <div class="input-group" style="margin-bottom:0; width:auto;">
                        <label style="font-size:0.85rem; color:var(--text-muted);">Filtrer par Collecteur :</label>
                        <select class="form-control" style="width:250px;" onchange="filterAnalysis(this.value)">
                            <option value="">-- Tous les collecteurs --</option>
                            ${collectors.map(c => `<option value="${c}" ${state.filterCollector===c?'selected':''}>${c}</option>`).join('')}
                        </select>
                    </div>
                    <button class="btn btn-info" onclick="exportToWord('${state.currentSurvey.id}')">üìÑ Rapport Word</button>
                </div>

                <div class="analysis-grid">
                    ${allQ.map(q => `
                        <div class="card" style="display:flex; flex-direction:column;">
                            <h3 style="font-size:1rem; margin-bottom:1rem; border-bottom:1px solid var(--border); padding-bottom:0.5rem;">${q.label}</h3>
                            <div style="flex:1;" id="analysis-${q.id}">
                                ${['select', 'radio', 'checkbox'].includes(q.type) ? `
                                    <div class="chart-container"><canvas id="chart-${q.id}"></canvas></div>
                                    <div class="axis-inputs">
                                        <input placeholder="Titre Axe X" value="${q.chartOptions?.axisX || ''}" onchange="updateAxisLabel('${q.id}', 'axisX', this.value)">
                                        <input placeholder="Titre Axe Y" value="${q.chartOptions?.axisY || ''}" onchange="updateAxisLabel('${q.id}', 'axisY', this.value)">
                                    </div>` : ''}
                                ${q.type === 'number' ? `<div id="stats-${q.id}"></div>` : ''}
                                ${['text', 'textarea', 'email', 'date'].includes(q.type) ? `<div id="list-${q.id}" style="max-height:200px; overflow-y:auto;"></div>` : ''}
                            </div>
                        </div>`).join('')}
                </div>
            `;
        }

        function renderCollectorAnalysis(responses) {
            const counts = {};
            responses.forEach(r => { const c = r.collector || 'Inconnu'; counts[c] = (counts[c] || 0) + 1; });
            const labels = Object.keys(counts); const data = Object.values(counts);
            
            setTimeout(() => {
                if (typeof Chart === 'undefined') return;
                const ctx = document.getElementById('coll-chart');
                if(ctx) {
                    new Chart(ctx, {
                        type: 'bar',
                        data: { labels, datasets: [{ label: 'R√©ponses', data, backgroundColor: '#4F46E5' }] },
                        options: { responsive: true, plugins: { legend: { display: false } } }
                    });
                }
            }, 100);

            return `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:2rem;">
                    <div class="card">
                        <h3>R√©partition</h3>
                        <div class="chart-container"><canvas id="coll-chart"></canvas></div>
                    </div>
                    <div class="card">
                        <h3>D√©tails</h3>
                        <div class="flex-end" style="margin-bottom:1rem;">
                            <button class="btn btn-info" onclick="exportCollectorsToWord()">üìÑ Rapport Collecteurs</button>
                        </div>
                        <div class="table-wrapper">
                            <table><thead><tr><th>Collecteur</th><th>R√©ponses</th><th>%</th></tr></thead><tbody>
                                ${labels.map((l,i) => `<tr><td>${l}</td><td>${data[i]}</td><td>${((data[i]/responses.length)*100).toFixed(1)}%</td></tr>`).join('')}
                            </tbody></table>
                        </div>
                    </div>
                </div>
            `;
        }

        function initCharts(responses, questions, attempt = 0) {
            if (typeof Chart === 'undefined') {
                if (attempt < 3) {
                    setTimeout(() => initCharts(responses, questions, attempt + 1), 500);
                } else {
                    console.error("Chart.js failed to load.");
                }
                return;
            }

            // Nettoyage des anciens graphiques pour √©viter les bugs d'affichage
            if (state.activeCharts) {
                state.activeCharts.forEach(c => c.destroy());
            }
            state.activeCharts = [];

            questions.forEach(q => {
                const data = responses.map(r => r.data[q.id]).filter(v => v !== undefined && v !== "");
                
                if (['select', 'radio', 'checkbox'].includes(q.type)) {
                    const counts = {};
                    data.forEach(v => { if (Array.isArray(v)) v.forEach(i => counts[i] = (counts[i] || 0) + 1); else counts[v] = (counts[v] || 0) + 1; });
                    const ctx = document.getElementById(`chart-${q.id}`);
                    if (ctx) {
                        const newChart = new Chart(ctx, {
                            type: q.type === 'checkbox' ? 'bar' : 'doughnut',
                            data: { labels: Object.keys(counts), datasets: [{ label: 'R√©ponses', data: Object.values(counts), backgroundColor: ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'], borderWidth: 1 }] },
                            options: { 
                                responsive: true, 
                                maintainAspectRatio: false,
                                plugins: { title: { display: true, text: `Axe X: ${q.chartOptions?.axisX || ''} | Axe Y: ${q.chartOptions?.axisY || ''}` } }
                            }
                        });
                        state.activeCharts.push(newChart);
                    }
                }
                else if (q.type === 'number') {
                    const nums = data.map(v => parseFloat(v)).filter(v => !isNaN(v));
                    const container = document.getElementById(`stats-${q.id}`);
                    if (container) {
                        if (nums.length > 0) {
                            const sum = nums.reduce((a,b)=>a+b, 0); const avg = sum / nums.length; const min = Math.min(...nums); const max = Math.max(...nums);
                            container.innerHTML = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;"><div class="stat-box"><div class="stat-num">${avg.toFixed(2)}</div><div class="stat-lbl">Moyenne</div></div><div class="stat-box"><div class="stat-num">${sum}</div><div class="stat-lbl">Somme</div></div><div class="stat-box"><div class="stat-num">${min}</div><div class="stat-lbl">Min</div></div><div class="stat-box"><div class="stat-num">${max}</div><div class="stat-lbl">Max</div></div></div>`;
                        } else {
                            container.innerHTML = `<p class="text-sm">Pas de donn√©es num√©riques valides.</p>`;
                        }
                    }
                }
                else if (['text', 'textarea', 'email', 'date'].includes(q.type)) {
                    const container = document.getElementById(`list-${q.id}`);
                    if (container) container.innerHTML = data.slice(0, 10).map(t => `<div style="padding:0.5rem; background:#f8fafc; margin-bottom:0.25rem; font-size:0.85rem; border-radius:4px;">${t}</div>`).join('') + (data.length>10?`<div class="text-sm">+ ${data.length-10} autres...</div>`:'');
                }
            });
        }

        function renderOfflineHome(app) {
            const count = (state.responses[state.currentSurvey.id] || []).length;
            app.innerHTML = `
                <div style="max-width:600px; margin: 2rem auto;">
                    <div class="badge-offline" style="justify-content:center;">‚ö†Ô∏è Mode Autonome (Verrouill√©)</div>
                    <div class="card" style="text-align:center; padding:3rem 2rem;">
                        <h1 style="color:var(--primary); margin-bottom:1rem;">${state.currentSurvey.title}</h1>
                        <div style="margin-bottom:2rem; padding:1rem; background:#f8fafc; border-radius:8px;">
                            <p>Collecteur actif : <span style="font-weight:bold; color:var(--primary);">${state.collectorName||"Non d√©fini"}</span></p>
                            <p style="font-size:2rem; font-weight:800; color:var(--secondary); margin:0.5rem 0;">${count}</p>
                            <p class="text-sm">R√©ponses stock√©es</p>
                        </div>
                        <div style="display:grid; gap:1rem;">
                            <button class="btn btn-primary" style="padding:1rem; font-size:1.1rem;" onclick="navigateTo('collect')">üìù Nouvelle Saisie</button>
                            <button class="btn btn-info" style="padding:1rem;" onclick="exportSyncData()">üì¶ Exporter les donn√©es (Sync)</button>
                            <button class="btn btn-secondary" onclick="navigateTo('results')">üìä Voir mes saisies</button>
                        </div>
                    </div>
                </div>
            `;
        }

        init();
    </script>
</body>
</html>
