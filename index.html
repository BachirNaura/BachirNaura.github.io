<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SahelStats Pro - Suite Compl√®te</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Palette de couleurs "World Class SaaS" */
            --primary: #4F46E5;       /* Indigo 600 */
            --primary-dark: #4338ca;  /* Indigo 700 */
            --primary-light: #e0e7ff; /* Indigo 100 */
            
            --secondary: #0f172a;     /* Slate 900 */
            --surface: #ffffff;
            --background: #f1f5f9;    /* Slate 100 */
            
            --text-main: #1e293b;     /* Slate 800 */
            --text-muted: #64748b;    /* Slate 500 */
            
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0ea5e9;          /* Sky 500 */
            
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Navbar Premium --- */
        .navbar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: var(--shadow-sm);
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .brand span { color: var(--secondary); }

        .nav-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .avatar {
            width: 38px;
            height: 38px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* --- Container --- */
        .main-container {
            flex: 1;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* --- Typography --- */
        h1 { font-size: 1.875rem; font-weight: 700; color: var(--secondary); margin-bottom: 0.5rem; letter-spacing: -0.025em; }
        h2 { font-size: 1.25rem; font-weight: 600; color: var(--text-main); margin-bottom: 1rem; }
        p.subtitle { color: var(--text-muted); margin-bottom: 2rem; max-width: 600px; }

        /* --- Cards --- */
        .card {
            background: var(--surface);
            border-radius: var(--radius-xl);
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover { box-shadow: var(--shadow-md); }
        .card.no-hover:hover { box-shadow: var(--shadow-sm); transform: none; }

        /* --- Buttons --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; }
        
        .btn-danger { background: #fee2e2; color: #991b1b; }
        .btn-danger:hover { background: #fecaca; }

        .btn-info { background: var(--info); color: white; }
        .btn-info:hover { background: #0284c7; }

        .btn-ghost { background: transparent; color: var(--text-muted); padding: 0.5rem; }
        .btn-ghost:hover { background: #f1f5f9; color: var(--secondary); }

        /* --- Inputs & Forms --- */
        .input-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-main); font-size: 0.9rem; }
        
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s;
            background: #fcfcfc;
        }

        .form-control:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        /* --- Tabs --- */
        .tabs-container {
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        .tab-btn:hover:not(.active) { color: var(--text-main); }

        /* --- Analysis Grid --- */
        .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
        .chart-container { position: relative; height: 250px; width: 100%; }
        
        /* Stats Numeric */
        .stat-box {
            background: #f8fafc; 
            padding: 1rem; 
            border-radius: var(--radius-md); 
            text-align: center;
            border: 1px solid var(--border);
        }
        .stat-num { font-size: 1.5rem; font-weight: 700; color: var(--secondary); }
        .stat-lbl { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.05em; margin-top: 0.25rem; }

        /* --- Tables --- */
        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            background: white;
        }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        thead { background: #f8fafc; border-bottom: 1px solid var(--border); }
        th { text-align: left; padding: 1rem; font-weight: 600; color: var(--text-muted); white-space: nowrap; }
        td { padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-main); }
        tr:last-child td { border-bottom: none; }
        tbody tr:hover { background: #f8fafc; }
        
        td[contenteditable="true"]:focus {
            background: white;
            box-shadow: inset 0 0 0 2px var(--primary);
            padding: 0.9rem;
        }

        /* --- Toaster (Notifications) --- */
        #toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            background: var(--secondary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            min-width: 300px;
        }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.info { border-left: 4px solid var(--info); }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* --- Helpers & Responsive --- */
        .flex-between { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .flex-end { display: flex; justify-content: flex-end; gap: 0.75rem; flex-wrap: wrap; }
        .hidden { display: none !important; }
        .text-sm { font-size: 0.85rem; color: var(--text-muted); }
        .badge-offline { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; padding: 0.5rem 1rem; border-radius: var(--radius-md); font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 2rem;}

        @media (max-width: 768px) {
            .navbar { padding: 0 1rem; height: 60px; }
            .main-container { padding: 1rem; }
            .header-actions { flex-direction: column; align-items: stretch; gap: 1rem; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <nav class="navbar">
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--primary)"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
            Sahel<span>Stats</span> <span style="font-weight:300; font-size:0.8em; margin-left:5px; color:var(--text-muted)"></span>
        </div>
        <div class="nav-profile">
            <span id="nav-mode-label">Mode Connect√©</span>
            <div class="avatar">üë®‚Äçüî¨</div>
        </div>
    </nav>

    <div id="app" class="main-container"></div>

    <script>
        /**
         * LOGIQUE C≈íUR DE L'APPLICATION
         * Inclut: Gestion Type Num√©rique, Exports Excel/CSV et WORD (avec images)
         */

        const embeddedSurveyData = null; 
        
        // √âtat Global
        let state = {
            view: 'list',
            surveys: [],
            currentSurvey: null,
            responses: {},
            formData: {},
            resultsTab: 'data', 
            isOfflineMode: false
        };

        const questionTypes = [
            { value: 'text', label: 'Texte court' },
            { value: 'number', label: 'Nombre (Entier/D√©cimal)' }, 
            { value: 'date', label: 'Date' },
            { value: 'select', label: 'Liste d√©roulante' },
            { value: 'radio', label: 'Choix unique (Radio)' },
            { value: 'checkbox', label: 'Choix multiple (Cases)' },
            { value: 'textarea', label: 'Paragraphe' },
            { value: 'email', label: 'Email' }
        ];

        // --- Syst√®me de Notifications (Toast) ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${type === 'success' ? '‚úÖ' : (type==='error'?'‚ö†Ô∏è':'‚ÑπÔ∏è')}</span><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- Initialisation ---
        function init() {
            if (embeddedSurveyData) {
                state.isOfflineMode = true;
                state.surveys = [embeddedSurveyData];
                state.currentSurvey = embeddedSurveyData;
                
                const savedResponses = localStorage.getItem(`responses_${embeddedSurveyData.id}`);
                state.responses = savedResponses ? { [embeddedSurveyData.id]: JSON.parse(savedResponses) } : { [embeddedSurveyData.id]: [] };

                document.getElementById('nav-mode-label').textContent = "Mode Autonome";
                navigateTo('offline-home');
            } else {
                loadData();
                render();
            }
        }

        function loadData() {
            const savedSurveys = localStorage.getItem('surveys');
            const savedResponses = localStorage.getItem('responses');
            if (savedSurveys) state.surveys = JSON.parse(savedSurveys);
            if (savedResponses) state.responses = JSON.parse(savedResponses);
        }

        function saveData() {
            if (state.isOfflineMode) {
                localStorage.setItem(`responses_${state.currentSurvey.id}`, JSON.stringify(state.responses[state.currentSurvey.id]));
            } else {
                localStorage.setItem('surveys', JSON.stringify(state.surveys));
                localStorage.setItem('responses', JSON.stringify(state.responses));
            }
        }

        // --- Navigation ---
        function navigateTo(view, surveyId = null) {
            state.view = view;
            if (surveyId && !state.isOfflineMode) {
                state.currentSurvey = state.surveys.find(s => s.id === surveyId);
            }
            state.formData = {}; 
            state.resultsTab = 'data';
            window.scrollTo(0,0);
            render();
        }

        // --- Logique M√©tier : Enqu√™tes ---
        function createNewSurvey() {
            const newSurvey = {
                id: Date.now().toString(),
                title: 'Nouvelle enqu√™te',
                description: '',
                sections: [{ id: Date.now().toString(), name: 'Section Principale', questions: [] }],
                createdAt: new Date().toISOString()
            };
            state.currentSurvey = newSurvey;
            navigateTo('create');
        }

        function submitResponse() {
            const allQuestions = state.currentSurvey.sections.flatMap(s => s.questions);
            for (const q of allQuestions) {
                if (q.required) {
                    const val = state.formData[q.id];
                    if (val === undefined || val === "" || (Array.isArray(val) && val.length === 0)) {
                        showToast(`La question "${q.label}" est obligatoire.`, 'error');
                        return;
                    }
                }
            }

            const surveyId = state.currentSurvey.id;
            if (!state.responses[surveyId]) state.responses[surveyId] = [];
            
            state.responses[surveyId].push({
                id: Date.now().toString(),
                timestamp: new Date().toISOString(),
                data: state.formData
            });
            
            saveData();
            showToast("R√©ponse enregistr√©e avec succ√®s !");
            
            setTimeout(() => {
                state.isOfflineMode ? navigateTo('offline-home') : navigateTo('list');
            }, 1000);
        }

        // --- MODULE D'EXPORTATION ---
        
        function getCleanDataForExport(surveyId) {
            const survey = state.currentSurvey || state.surveys.find(s => s.id === surveyId);
            const responses = state.responses[survey.id] || [];
            const allQuestions = survey.sections.flatMap(s => s.questions);
            return { survey, responses, allQuestions };
        }

        // 1. Export EXCEL
        function exportToExcel(surveyId) {
            const { survey, responses, allQuestions } = getCleanDataForExport(surveyId);
            if (responses.length === 0) { showToast("Aucune donn√©e √† exporter.", "error"); return; }

            const data = responses.map(r => {
                let row = {
                    'ID': r.id,
                    'Date': new Date(r.timestamp).toLocaleDateString() + ' ' + new Date(r.timestamp).toLocaleTimeString()
                };
                allQuestions.forEach(q => {
                    let val = r.data[q.id];
                    if (q.type === 'number') {
                        row[q.label] = (val === "" || val === null || val === undefined) ? "" : Number(val);
                    } else if (Array.isArray(val)) {
                        row[q.label] = val.join('; ');
                    } else {
                        row[q.label] = val;
                    }
                });
                return row;
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            const wscols = [{wch: 15}, {wch: 20}];
            allQuestions.forEach(() => wscols.push({wch: 25}));
            ws['!cols'] = wscols;

            XLSX.utils.book_append_sheet(wb, ws, "Donn√©es");
            XLSX.writeFile(wb, `Export_${survey.title.replace(/\s+/g, '_')}.xlsx`);
            showToast("Export Excel g√©n√©r√© !");
        }

        // 2. Export CSV
        function exportToCSV(surveyId) {
            const { survey, responses, allQuestions } = getCleanDataForExport(surveyId);
            if (responses.length === 0) { showToast("Aucune donn√©e √† exporter.", "error"); return; }

            const headers = ['ID', 'Date', ...allQuestions.map(q => q.label)];
            const rows = responses.map(r => {
                const date = new Date(r.timestamp).toLocaleString();
                const values = allQuestions.map(q => {
                    let val = r.data[q.id];
                    if (Array.isArray(val)) val = val.join('; ');
                    if (val === undefined || val === null) val = '';
                    return `"${String(val).replace(/"/g, '""')}"`;
                });
                return [r.id, date, ...values].join(',');
            });

            const csvContent = [headers.join(','), ...rows].join('\n');
            downloadFile(csvContent, `Export_${survey.title.replace(/\s+/g, '_')}.csv`, 'text/csv');
            showToast("Export CSV g√©n√©r√© !");
        }

        // 3. Export WORD (Rapport avec Graphiques)
        function exportToWord(surveyId) {
            const { survey, responses, allQuestions } = getCleanDataForExport(surveyId);
            if (responses.length === 0) { showToast("Aucune donn√©e √† exporter.", "error"); return; }
            if (state.resultsTab !== 'analysis') { showToast("Veuillez aller sur l'onglet 'Analyse' pour g√©n√©rer les graphiques avant l'export.", "info"); return; }

            showToast("G√©n√©ration du rapport Word en cours...");

            // Construction du contenu HTML pour Word
            let htmlBody = `
                <div style="font-family: Arial, sans-serif; padding: 20px;">
                    <h1 style="color: #4F46E5; text-align: center;">${survey.title}</h1>
                    <p style="text-align: center; color: #666;">${survey.description || ''}</p>
                    <p style="text-align: center;"><strong>Rapport g√©n√©r√© le :</strong> ${new Date().toLocaleString()}</p>
                    <p style="text-align: center;"><strong>Total r√©ponses :</strong> ${responses.length}</p>
                    <hr />
            `;

            allQuestions.forEach((q, idx) => {
                htmlBody += `<h2 style="color: #1e293b; margin-top: 30px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;">${idx + 1}. ${q.label}</h2>`;
                
                const data = responses.map(r => r.data[q.id]).filter(v => v !== undefined && v !== "");

                // Graphiques (Images)
                if (['select', 'radio', 'checkbox'].includes(q.type)) {
                    const canvas = document.getElementById(`chart-${q.id}`);
                    if (canvas) {
                        try {
                            const imgData = canvas.toDataURL("image/png");
                            htmlBody += `<div style="text-align:center; margin: 20px 0;"><img src="${imgData}" width="500" style="width:500px;" /></div>`;
                        } catch(e) { htmlBody += `<p style="color:red;">Erreur g√©n√©ration image</p>`; }
                    } else {
                        htmlBody += `<p style="font-style:italic; color:gray;">Graphique non charg√©.</p>`;
                    }
                } 
                // Stats num√©riques
                else if (q.type === 'number') {
                    const nums = data.map(v => parseFloat(v)).filter(v => !isNaN(v));
                    if (nums.length > 0) {
                        const sum = nums.reduce((a,b)=>a+b, 0);
                        const avg = (sum / nums.length).toFixed(2);
                        const min = Math.min(...nums);
                        const max = Math.max(...nums);
                        htmlBody += `
                            <table border="1" cellpadding="10" cellspacing="0" style="width:100%; border-collapse: collapse; margin-top:10px;">
                                <tr style="background:#f1f5f9;"><th>Moyenne</th><th>Somme</th><th>Minimum</th><th>Maximum</th></tr>
                                <tr>
                                    <td align="center">${avg}</td><td align="center">${sum}</td><td align="center">${min}</td><td align="center">${max}</td>
                                </tr>
                            </table>
                        `;
                    } else { htmlBody += `<p>Pas de donn√©es.</p>`; }
                }
                // Texte
                else {
                    htmlBody += `<ul style="background:#f8fafc; padding:15px; border:1px solid #ddd;">`;
                    data.slice(0, 10).forEach(txt => { htmlBody += `<li>${txt}</li>`; });
                    if(data.length > 10) htmlBody += `<li>... (+${data.length-10} autres)</li>`;
                    htmlBody += `</ul>`;
                }
            });

            htmlBody += `</div>`;

            // Enveloppe Word XML/HTML
            const preHtml = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export HTML To Doc</title></head><body>";
            const postHtml = "</body></html>";
            const html = preHtml + htmlBody + postHtml;

            const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Rapport_${survey.title.replace(/\s+/g, '_')}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToJSON(surveyId) {
             const { survey, responses } = getCleanDataForExport(surveyId);
             const data = { survey, responses, date: new Date() };
             downloadFile(JSON.stringify(data, null, 2), `Backup_${survey.title}.json`, 'application/json');
             showToast("Export JSON g√©n√©r√© !");
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type + ';charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function downloadOfflineApp(surveyId) {
            const survey = state.surveys.find(s => s.id === surveyId);
            const htmlContent = document.documentElement.outerHTML;
            const marker = "const embeddedSurveyData = null;";
            const injection = `const embeddedSurveyData = ${JSON.stringify(survey)};`;
            
            if (!htmlContent.includes(marker)) {
                showToast("Erreur lors de la g√©n√©ration de l'app.", "error");
                return;
            }

            const finalHtml = htmlContent.replace(marker, injection);
            downloadFile(finalHtml, `App_${survey.title.replace(/[^a-z0-9]/gi, '_')}.html`, 'text/html');
            showToast("Application autonome t√©l√©charg√©e !");
        }

        // --- VUES (Rendu HTML) ---

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = ''; 

            switch(state.view) {
                case 'list': app.innerHTML = renderList(); attachListEvents(); break;
                case 'create': app.innerHTML = renderCreate(); attachCreateEvents(); break;
                case 'collect': app.innerHTML = renderCollect(); attachCollectEvents(); break;
                case 'results': app.innerHTML = renderResults(); attachResultsEvents(); break;
                case 'offline-home': app.innerHTML = renderOfflineHome(); attachOfflineEvents(); break;
            }
        }

        // 1. Vue Liste
        function renderList() {
            return `
                <div class="flex-between" style="margin-bottom:2rem;">
                    <div>
                        <h2>R√©alis√© par: Dr. MAGAGI ALI Bachir</h2>
                        <h1>Mes Enqu√™tes</h1>
                        <p class="subtitle">Tableau de bord des enqu√™tes.</p>
                    </div>
                    <button class="btn btn-primary" id="btn-new">
                        <span>+</span> Nouvelle Enqu√™te
                    </button>
                </div>
                
                ${state.surveys.length === 0 ? `
                    <div class="card no-hover" style="text-align:center; padding:4rem;">
                        <div style="font-size:3rem; margin-bottom:1rem;">üìÇ</div>
                        <h3>Aucune enqu√™te trouv√©e</h3>
                        <p class="text-sm">Commencez par cr√©er votre premier formulaire.</p>
                    </div>
                ` : `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 1.5rem;">
                        ${state.surveys.map(s => {
                            const count = (state.responses[s.id] || []).length;
                            const qCount = s.sections.reduce((acc, sec) => acc + sec.questions.length, 0);
                            return `
                            <div class="card" style="display:flex; flex-direction:column; justify-content:space-between; height:100%; border-top:4px solid var(--primary);">
                                <div>
                                    <h3 style="margin-bottom:0.5rem; color:var(--primary-dark);">${s.title}</h3>
                                    <p class="text-sm" style="height:40px; overflow:hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${s.description || 'Pas de description'}</p>
                                    
                                    <div style="display:flex; gap:1rem; margin:1rem 0; padding:0.75rem 0; border-top:1px dashed var(--border); border-bottom:1px dashed var(--border);">
                                        <span style="font-size:0.8rem; font-weight:600; color:var(--text-muted);">üìù ${qCount} Questions</span>
                                        <span style="font-size:0.8rem; font-weight:600; color:var(--primary);">üìä ${count} R√©ponses</span>
                                    </div>
                                </div>
                                <div class="flex-end" style="margin-top:1rem;">
                                    <button class="btn btn-secondary btn-sm" onclick="navigateTo('collect', '${s.id}')">Saisir</button>
                                    <button class="btn btn-secondary btn-sm" onclick="navigateTo('results', '${s.id}')">R√©sultats</button>
                                    <button class="btn btn-ghost" onclick="navigateTo('create', '${s.id}')">‚öôÔ∏è</button>
                                    <button class="btn btn-ghost" onclick="deleteSurvey('${s.id}')" style="color:var(--danger)">üóëÔ∏è</button>
                                    <button class="btn btn-ghost" onclick="downloadOfflineApp('${s.id}')" title="T√©l√©charger App">üíæ</button>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `}
            `;
        }

        // 2. Vue Cr√©ation
        function renderCreate() {
            return `
                <div class="flex-between" style="margin-bottom:2rem;">
                    <button class="btn btn-secondary" onclick="navigateTo('list')">‚Üê Retour</button>
                    <h1>${state.surveys.find(s => s.id === state.currentSurvey.id) ? '√âditer l\'enqu√™te' : 'Nouvelle Enqu√™te'}</h1>
                    <button class="btn btn-primary" id="btn-save">üíæ Enregistrer</button>
                </div>

                <div class="card no-hover" style="border-left: 4px solid var(--primary);">
                    <div class="input-group">
                        <label>Titre de l'enqu√™te</label>
                        <input type="text" class="form-control" id="survey-title" value="${state.currentSurvey.title}" style="font-size:1.1rem; font-weight:600;">
                    </div>
                    <div class="input-group">
                        <label>Description</label>
                        <textarea class="form-control" id="survey-desc" rows="2">${state.currentSurvey.description}</textarea>
                    </div>
                </div>

                <div id="sections-container"></div>
                
                <button class="btn btn-secondary" style="width:100%; border-style:dashed; margin-top:1rem;" id="btn-add-section">+ Ajouter une Section</button>
            `;
        }

        // 3. Vue Collecte
        function renderCollect() {
            const s = state.currentSurvey;
            return `
                <div style="max-width:800px; margin:0 auto;">
                    <div class="flex-between" style="margin-bottom:1rem;">
                        <button class="btn btn-ghost" onclick="state.isOfflineMode ? navigateTo('offline-home') : navigateTo('list')">‚Üê Annuler</button>
                        <div class="text-sm">Mode Collecte</div>
                    </div>

                    <div class="card no-hover" style="text-align:center; border-top: 5px solid var(--primary);">
                        <h1 style="font-size:1.5rem;">${s.title}</h1>
                        <p class="text-sm">${s.description}</p>
                    </div>

                    <form id="collect-form">
                        ${s.sections.map(sec => `
                            <div style="margin: 2rem 0 1rem 0; display:flex; align-items:center; gap:1rem;">
                                <div style="height:1px; background:var(--border); flex:1;"></div>
                                <h3 style="color:var(--primary); margin:0;">${sec.name}</h3>
                                <div style="height:1px; background:var(--border); flex:1;"></div>
                            </div>
                            
                            <div class="card">
                                ${sec.questions.map(q => renderQuestionInput(q)).join('')}
                            </div>
                        `).join('')}

                        <div style="margin: 2rem 0 5rem 0;">
                            <button type="button" class="btn btn-primary" style="width:100%; padding:1rem; font-size:1.1rem;" id="btn-submit">Envoyer la r√©ponse</button>
                        </div>
                    </form>
                </div>
            `;
        }

        function renderQuestionInput(q) {
            let inputHtml = '';
            const req = q.required ? '<span style="color:var(--danger)">*</span>' : '';
            
            if (q.type === 'text' || q.type === 'email' || q.type === 'date') {
                inputHtml = `<input type="${q.type}" class="form-control" data-qid="${q.id}">`;
            } else if (q.type === 'number') {
                inputHtml = `<input type="number" step="any" class="form-control" data-qid="${q.id}" placeholder="0.00">`;
            } else if (q.type === 'textarea') {
                inputHtml = `<textarea class="form-control" rows="3" data-qid="${q.id}"></textarea>`;
            } else if (q.type === 'select') {
                inputHtml = `<select class="form-control" data-qid="${q.id}">
                    <option value="">-- S√©lectionner --</option>
                    ${q.options.map(o => `<option value="${o}">${o}</option>`).join('')}
                </select>`;
            } else if (q.type === 'radio') {
                inputHtml = `<div style="display:flex; flex-direction:column; gap:0.5rem;">
                    ${q.options.map(o => `
                        <label style="display:flex; align-items:center; gap:0.5rem; font-weight:400; cursor:pointer;">
                            <input type="radio" name="${q.id}" value="${o}" data-qid="${q.id}"> ${o}
                        </label>`).join('')}
                </div>`;
            } else if (q.type === 'checkbox') {
                inputHtml = `<div style="display:flex; flex-direction:column; gap:0.5rem;">
                    ${q.options.map(o => `
                        <label style="display:flex; align-items:center; gap:0.5rem; font-weight:400; cursor:pointer;">
                            <input type="checkbox" value="${o}" data-qid="${q.id}" data-is-check="true"> ${o}
                        </label>`).join('')}
                </div>`;
            }

            return `<div class="input-group">
                <label>${q.label} ${req}</label>
                ${inputHtml}
            </div>`;
        }

        // 4. Vue R√©sultats & Analyse
        function renderResults() {
            const responses = state.responses[state.currentSurvey.id] || [];
            
            return `
                <div class="flex-between" style="margin-bottom:2rem;">
                    <button class="btn btn-secondary" onclick="state.isOfflineMode ? navigateTo('offline-home') : navigateTo('list')">‚Üê Retour</button>
                    <h1>R√©sultats : ${state.currentSurvey.title}</h1>
                    <div class="flex-end">
                        <button class="btn btn-secondary" onclick="exportToCSV('${state.currentSurvey.id}')">üìÇ CSV</button>
                        <button class="btn btn-success" onclick="exportToExcel('${state.currentSurvey.id}')">üìä Excel</button>
                        <button class="btn btn-ghost" onclick="exportToJSON('${state.currentSurvey.id}')">JSON</button>
                    </div>
                </div>

                <div class="card no-hover">
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; text-align:center;">
                        <div>
                            <div style="font-size:2rem; font-weight:800; color:var(--primary);">${responses.length}</div>
                            <div class="text-sm">R√©ponses totales</div>
                        </div>
                        <div>
                             <div style="font-size:2rem; font-weight:800; color:var(--success);">100%</div>
                            <div class="text-sm">Taux de compl√©tion</div>
                        </div>
                    </div>
                </div>

                <div class="tabs-container">
                    <button class="tab-btn ${state.resultsTab === 'data' ? 'active' : ''}" onclick="switchResultTab('data')">üìã Donn√©es Brutes</button>
                    <button class="tab-btn ${state.resultsTab === 'analysis' ? 'active' : ''}" onclick="switchResultTab('analysis')">üìà Analyse Graphique</button>
                </div>

                ${responses.length === 0 ? '<div class="card" style="text-align:center; padding:2rem;">Aucune donn√©e √† afficher.</div>' : (
                    state.resultsTab === 'data' ? renderDataTable(responses) : renderAnalysis(responses)
                )}
            `;
        }

        function renderDataTable(responses) {
            const allQ = state.currentSurvey.sections.flatMap(s => s.questions);
            return `
                <div class="table-wrapper card no-hover" style="padding:0;">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:50px;">#</th>
                                <th>Date</th>
                                ${allQ.map(q => `<th>${q.label}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${responses.map((r, idx) => `
                                <tr>
                                    <td style="color:var(--text-muted);">${idx + 1}</td>
                                    <td style="white-space:nowrap; font-size:0.85rem;">${new Date(r.timestamp).toLocaleDateString()}</td>
                                    ${allQ.map(q => {
                                        let val = r.data[q.id];
                                        let display = Array.isArray(val) ? val.join(', ') : (val ?? '');
                                        return `<td contenteditable="true" onblur="updateCell('${r.id}', '${q.id}', this, '${q.type}')">${display}</td>`;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderAnalysis(responses) {
            const allQ = state.currentSurvey.sections.flatMap(s => s.questions);
            setTimeout(() => initCharts(responses, allQ), 100); 

            return `
                <div class="flex-end" style="margin-bottom:1rem;">
                    <button class="btn btn-info" onclick="exportToWord('${state.currentSurvey.id}')">üìÑ T√©l√©charger Rapport Word</button>
                </div>
                <div class="analysis-grid">
                    ${allQ.map(q => {
                        return `
                        <div class="card" style="display:flex; flex-direction:column;">
                            <h3 style="font-size:1rem; margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:1px solid var(--border);">${q.label}</h3>
                            <div style="flex:1;" id="analysis-${q.id}">
                                ${['select', 'radio', 'checkbox'].includes(q.type) ? `<div class="chart-container"><canvas id="chart-${q.id}"></canvas></div>` : ''}
                                ${q.type === 'number' ? `<div id="stats-${q.id}"></div>` : ''}
                                ${['text', 'textarea', 'email', 'date'].includes(q.type) ? `<div id="list-${q.id}" style="max-height:200px; overflow-y:auto;"></div>` : ''}
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            `;
        }

        // --- Logique des Graphiques (Analyse) ---
        function initCharts(responses, questions) {
            questions.forEach(q => {
                const data = responses.map(r => r.data[q.id]).filter(v => v !== undefined && v !== "");
                
                // 1. Graphiques (Pie/Bar) pour choix
                if (['select', 'radio', 'checkbox'].includes(q.type)) {
                    const counts = {};
                    data.forEach(v => {
                        if (Array.isArray(v)) v.forEach(item => counts[item] = (counts[item] || 0) + 1);
                        else counts[v] = (counts[v] || 0) + 1;
                    });
                    
                    const ctx = document.getElementById(`chart-${q.id}`);
                    if (ctx) {
                        new Chart(ctx, {
                            type: q.type === 'checkbox' ? 'bar' : 'doughnut',
                            data: {
                                labels: Object.keys(counts),
                                datasets: [{
                                    label: 'R√©ponses',
                                    data: Object.values(counts),
                                    backgroundColor: ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'],
                                    borderWidth: 1
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                        });
                    }
                }
                
                // 2. Stats Num√©riques
                else if (q.type === 'number') {
                    const nums = data.map(v => parseFloat(v)).filter(v => !isNaN(v));
                    const container = document.getElementById(`stats-${q.id}`);
                    if (container && nums.length > 0) {
                        const sum = nums.reduce((a,b)=>a+b, 0);
                        const avg = sum / nums.length;
                        const min = Math.min(...nums);
                        const max = Math.max(...nums);
                        
                        container.innerHTML = `
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem;">
                                <div class="stat-box"><div class="stat-num">${avg.toFixed(2)}</div><div class="stat-lbl">Moyenne</div></div>
                                <div class="stat-box"><div class="stat-num">${sum}</div><div class="stat-lbl">Somme</div></div>
                                <div class="stat-box"><div class="stat-num">${min}</div><div class="stat-lbl">Min</div></div>
                                <div class="stat-box"><div class="stat-num">${max}</div><div class="stat-lbl">Max</div></div>
                            </div>
                        `;
                    } else if (container) {
                        container.innerHTML = `<p class="text-sm">Pas de donn√©es num√©riques valides.</p>`;
                    }
                }
                
                // 3. Listes Textuelles
                else if (['text', 'textarea', 'email', 'date'].includes(q.type)) {
                    const container = document.getElementById(`list-${q.id}`);
                    if (container) {
                        container.innerHTML = data.slice(0, 10).map(txt => 
                            `<div style="padding:0.5rem; background:#f8fafc; margin-bottom:0.25rem; font-size:0.85rem; border-radius:4px;">${txt}</div>`
                        ).join('') + (data.length > 10 ? `<div class="text-sm" style="margin-top:0.5rem;">+ ${data.length - 10} autres...</div>` : '');
                    }
                }
            });
        }

        // Vue Offline Home
        function renderOfflineHome() {
            const count = (state.responses[state.currentSurvey.id] || []).length;
            return `
                <div style="max-width:600px; margin: 2rem auto;">
                    <div class="badge-offline">
                        <span>‚ö†Ô∏è Mode Autonome</span> 
                        <span>Les donn√©es sont stock√©es localement.</span>
                    </div>
                    
                    <div class="card" style="text-align:center; padding:3rem 2rem;">
                        <h1 style="color:var(--primary); margin-bottom:1rem;">${state.currentSurvey.title}</h1>
                        <p class="subtitle" style="margin:0 auto 2rem auto;">${state.currentSurvey.description || "Pr√™t pour la collecte."}</p>
                        
                        <div style="display:inline-block; padding: 0.5rem 1.5rem; background:var(--primary-light); color:var(--primary-dark); border-radius:30px; font-weight:700; margin-bottom:2rem;">
                            ${count} R√©ponses stock√©es
                        </div>

                        <div style="display:grid; gap:1rem;">
                            <button class="btn btn-primary" style="padding:1rem; font-size:1.1rem;" onclick="navigateTo('collect')">üìù Collecter une donn√©e</button>
                            <button class="btn btn-secondary" style="padding:1rem;" onclick="navigateTo('results')">üìä Voir & Exporter R√©sultats</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Event Listeners & Helpers ---

        function attachCreateEvents() {
            const container = document.getElementById('sections-container');
            const surveyTitle = document.getElementById('survey-title');
            const surveyDesc = document.getElementById('survey-desc');
            const btnAddSection = document.getElementById('btn-add-section');
            const btnSave = document.getElementById('btn-save');

            surveyTitle.oninput = (e) => state.currentSurvey.title = e.target.value;
            surveyDesc.oninput = (e) => state.currentSurvey.description = e.target.value;

            function renderSections() {
                container.innerHTML = state.currentSurvey.sections.map((sec, sIdx) => `
                    <div class="card section-block" style="border-left:4px solid var(--text-muted);">
                        <div class="flex-between" style="margin-bottom:1rem;">
                            <input type="text" value="${sec.name}" class="form-control" style="font-weight:600; width:auto; flex:1; margin-right:1rem;" oninput="updateSectionName('${sec.id}', this.value)">
                            <button class="btn btn-danger" style="padding:0.4rem;" onclick="removeSection('${sec.id}')">üóëÔ∏è</button>
                        </div>
                        
                        <div id="q-list-${sec.id}">
                            ${sec.questions.map((q, qIdx) => `
                                <div class="card" style="background:#f8fafc; border:1px solid var(--border); padding:1rem; margin-bottom:0.8rem;">
                                    <div class="flex-between" style="gap:1rem; margin-bottom:0.5rem;">
                                        <input type="text" class="form-control" value="${q.label}" placeholder="Question" oninput="updateQ('${sec.id}', '${q.id}', 'label', this.value)">
                                        <select class="form-control" style="width:150px;" onchange="updateQ('${sec.id}', '${q.id}', 'type', this.value)">
                                            ${questionTypes.map(t => `<option value="${t.value}" ${t.value === q.type ? 'selected':''}>${t.label}</option>`).join('')}
                                        </select>
                                        <button class="btn btn-ghost" style="color:var(--danger)" onclick="removeQ('${sec.id}', '${q.id}')">‚úñ</button>
                                    </div>
                                    
                                    <div class="flex-between">
                                        <div style="flex:1;">
                                            ${['select', 'radio', 'checkbox'].includes(q.type) ? `
                                                <input type="text" class="form-control" placeholder="Options s√©par√©es par virgule" value="${q.options.join(',')}" onchange="updateQ('${sec.id}', '${q.id}', 'options', this.value)">
                                            ` : ''}
                                        </div>
                                        <label style="margin-left:1rem; display:flex; align-items:center; gap:0.5rem;">
                                            <input type="checkbox" ${q.required ? 'checked':''} onchange="updateQ('${sec.id}', '${q.id}', 'required', this.checked)"> Obligatoire
                                        </label>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="addQ('${sec.id}')">+ Ajouter Question</button>
                    </div>
                `).join('');
            }

            renderSections();

            window.addQ = (secId) => {
                const sec = state.currentSurvey.sections.find(s => s.id === secId);
                sec.questions.push({ id: Date.now().toString(), type: 'text', label: '', required: false, options: [] });
                renderSections();
            };
            window.removeQ = (secId, qId) => {
                const sec = state.currentSurvey.sections.find(s => s.id === secId);
                sec.questions = sec.questions.filter(q => q.id !== qId);
                renderSections();
            };
            window.updateQ = (secId, qId, field, val) => {
                const sec = state.currentSurvey.sections.find(s => s.id === secId);
                const q = sec.questions.find(qu => qu.id === qId);
                if(field === 'options') q.options = val.split(',').map(o=>o.trim());
                else q[field] = val;
                if(field === 'type') renderSections();
            };
            window.updateSectionName = (id, val) => {
                state.currentSurvey.sections.find(s => s.id === id).name = val;
            };
            window.removeSection = (id) => {
                if(confirm('Supprimer cette section ?')) {
                    state.currentSurvey.sections = state.currentSurvey.sections.filter(s => s.id !== id);
                    renderSections();
                }
            };

            btnAddSection.onclick = () => {
                state.currentSurvey.sections.push({ id: Date.now().toString(), name: 'Nouvelle Section', questions: [] });
                renderSections();
            };

            btnSave.onclick = () => {
                const existingIdx = state.surveys.findIndex(s => s.id === state.currentSurvey.id);
                if (existingIdx >= 0) state.surveys[existingIdx] = state.currentSurvey;
                else state.surveys.push(state.currentSurvey);
                
                saveData();
                showToast("Enqu√™te sauvegard√©e !");
                navigateTo('list');
            };
        }

        function attachListEvents() {
            document.getElementById('btn-new').onclick = createNewSurvey;
            window.deleteSurvey = (id) => {
                if(confirm('√ätes-vous s√ªr ? Toutes les donn√©es seront perdues.')) {
                    state.surveys = state.surveys.filter(s => s.id !== id);
                    delete state.responses[id];
                    saveData();
                    render();
                    showToast("Enqu√™te supprim√©e", "error");
                }
            };
        }

        function attachCollectEvents() {
            document.getElementById('btn-submit').onclick = submitResponse;

            const form = document.getElementById('collect-form');
            form.addEventListener('input', (e) => {
                const target = e.target;
                const qid = target.dataset.qid;
                if (!qid) return;

                if (target.type === 'checkbox') {
                    if (!state.formData[qid]) state.formData[qid] = [];
                    if (target.checked) state.formData[qid].push(target.value);
                    else state.formData[qid] = state.formData[qid].filter(v => v !== target.value);
                } 
                else if (target.type === 'number') {
                    // Force la conversion en nombre imm√©diatement
                    if (target.value === "") state.formData[qid] = "";
                    else state.formData[qid] = parseFloat(target.value);
                } 
                else if (target.type === 'radio') {
                    if (target.checked) state.formData[qid] = target.value;
                } 
                else {
                    state.formData[qid] = target.value;
                }
            });
        }

        function attachResultsEvents() {
            window.switchResultTab = (tab) => {
                state.resultsTab = tab;
                render();
            };

            window.updateCell = (respId, qId, cell, type) => {
                const val = cell.innerText;
                const surveyId = state.currentSurvey.id;
                const resp = state.responses[surveyId].find(r => r.id === respId);
                
                if (resp) {
                    if (type === 'number') {
                        const num = parseFloat(val);
                        resp.data[qId] = isNaN(num) ? val : num;
                    } else {
                        resp.data[qId] = val;
                    }
                    saveData();
                    showToast("Valeur mise √† jour");
                }
            };
        }

        function attachOfflineEvents() {
            // G√©r√© par les onclicks HTML
        }

        // Lancement
        init();

    </script>
</body>
</html>
